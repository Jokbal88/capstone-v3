{% extends 'mainv2.html' %}
{% load static tailwind_tags %}
{% block title %}HealthHub Connect | Medical Requirements Tracker{% endblock %}
{% block extra_css %}
{% tailwind_css %}
{% endblock %}

{% block content %}
<div class="w-full h-screen rounded-[14px] bg-white xs:p-4 md:p-8 flex flex-col gap-2">
    <h2 class="font-bold text-[1.5rem] text-black tracking-tight text-center mb-2">Medical Requirements Tracker</h2>
    {% if user.is_superuser or user.is_staff %}
        <form method="POST" class="flex gap-4 mb-4">
            {% csrf_token %}
            <input type="text" name="student_id" placeholder="Search by Student ID" class="w-full p-2 border rounded-md">
            <button type="submit" class="bg-[#3b82f6] text-white py-2 px-8 rounded-md hover:bg-[#2563eb] transition-colors">
                Search
            </button>
        </form>
    {% endif %}
    <div class="bg-[#f8fafc] rounded-lg p-4 mb-2 border border-gray-200">
        <h3 class="font-semibold text-blue-700 mb-2">Required Medical Documents</h3>
        <div class="mb-4 p-3 bg-blue-50 rounded-md border border-blue-100">
            <p class="text-sm text-blue-800">Please review and update all required medical documents for students. These are essential for ensuring the health and safety of all students.</p>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full table-auto border-separate border-spacing-0 rounded-lg overflow-hidden shadow text-base">
                <thead class="bg-[#e6e6e6]">
                    <tr>
                        <th class="p-2 text-left w-1/3">Remarks</th>
                        <th class="p-2 text-left">Requirement</th>
                        <th class="p-2 text-center">Status</th>
                        <th class="p-2 text-center">File</th>
                </tr>
            </thead>
            <tbody>
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2">
                            <form method="POST" class="flex gap-2 items-center">
                                {% csrf_token %}
                                <input type="text" name="x-ray-remark" value="{{ med_requirements.x_ray_remarks }}" class="w-full p-2 border rounded-md text-base" placeholder="Enter remarks here...">
                                <button type="submit" name="save_remark" value="x-ray" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 whitespace-nowrap">Save</button>
                            </form>
                        </td>
                        <td class="p-2 font-medium">Chest X-ray</td>
                        {% if med_requirements.chest_xray %}
                            <td class="p-2 text-center text-green-600 font-bold">&#10003;</td>
                            <td class="p-2 text-center"><a href="{{ med_requirements.chest_xray.url }}" class="text-blue-600 hover:underline">Preview</a></td>
                        {% else %}
                            <td class="p-2 text-center text-red-600 font-bold">&#10007;</td>
                            <td class="p-2 text-center text-gray-400">None</td>
                    {% endif %}
                </tr>
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2">
                            <form method="POST" class="flex gap-2 items-center">
                                {% csrf_token %}
                                <input type="text" name="cbc-remark" value="{{ med_requirements.cbc_remarks }}" class="w-full p-2 border rounded-md text-base" placeholder="Enter remarks here...">
                                <button type="submit" name="save_remark" value="cbc" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 whitespace-nowrap">Save</button>
                            </form>
                        </td>
                        <td class="p-2 font-medium">Complete Blood Count (CBC)</td>
                        {% if med_requirements.cbc %}
                            <td class="p-2 text-center text-green-600 font-bold">&#10003;</td>
                            <td class="p-2 text-center"><a href="{{ med_requirements.cbc.url }}" class="text-blue-600 hover:underline">Preview</a></td>
                        {% else %}
                            <td class="p-2 text-center text-red-600 font-bold">&#10007;</td>
                            <td class="p-2 text-center text-gray-400">None</td>
                    {% endif %}
                </tr>
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2">
                            <form method="POST" class="flex gap-2 items-center">
                                {% csrf_token %}
                                <input type="text" name="drug-test-remark" value="{{ med_requirements.drug_test_remarks }}" class="w-full p-2 border rounded-md text-base" placeholder="Enter remarks here...">
                                <button type="submit" name="save_remark" value="drug-test" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 whitespace-nowrap">Save</button>
                            </form>
                        </td>
                        <td class="p-2 font-medium">Drug Test</td>
                        {% if med_requirements.drug_test %}
                            <td class="p-2 text-center text-green-600 font-bold">&#10003;</td>
                            <td class="p-2 text-center"><a href="{{ med_requirements.drug_test.url }}" class="text-blue-600 hover:underline">Preview</a></td>
                        {% else %}
                            <td class="p-2 text-center text-red-600 font-bold">&#10007;</td>
                            <td class="p-2 text-center text-gray-400">None</td>
                    {% endif %}
                </tr>
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2">
                            <form method="POST" class="flex gap-2 items-center">
                                {% csrf_token %}
                                <input type="text" name="stool-examination-remark" value="{{ med_requirements.stool_examination_remarks }}" class="w-full p-2 border rounded-md text-base" placeholder="Enter remarks here...">
                                <button type="submit" name="save_remark" value="stool-examination" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 whitespace-nowrap">Save</button>
                            </form>
                        </td>
                        <td class="p-2 font-medium">Stool Examination</td>
                        {% if med_requirements.stool_examination %}
                            <td class="p-2 text-center text-green-600 font-bold">&#10003;</td>
                            <td class="p-2 text-center"><a href="{{ med_requirements.stool_examination.url }}" class="text-blue-600 hover:underline">Preview</a></td>
                        {% else %}
                            <td class="p-2 text-center text-red-600 font-bold">&#10007;</td>
                            <td class="p-2 text-center text-gray-400">None</td>
                    {% endif %}
                </tr>
                {% if med_requirements.pwd_card %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2">
                            <form method="POST" class="flex gap-2 items-center">
                                {% csrf_token %}
                                <input type="text" name="pwd-card-remark" value="{{ med_requirements.pwd_card_remarks }}" class="w-full p-2 border rounded-md text-base" placeholder="Enter remarks here...">
                                <button type="submit" name="save_remark" value="pwd-card" class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600 whitespace-nowrap">Save</button>
                            </form>
                            </td>
                        <td class="p-2 font-medium">PWD Card</td>
                        <td class="p-2 text-center text-green-600 font-bold">&#10003;</td>
                        <td class="p-2 text-center"><a href="{{ med_requirements.pwd_card.url }}" class="text-blue-600 hover:underline">Preview</a></td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    </div>
    {% if not user.is_superuser and not user.is_staff %}
        <button class="bg-[#3b82f6] mt-8 text-white text-[14px] py-2 px-4 rounded-md w-full cursor-pointer">
            <a href="{% url 'medical:upload_requirements' %}">Upload Requirement</a>
        </button>
    {% endif %}
</div>

<div id="previewModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="previewContainer">
            <!-- For PDFs -->
            <object id="filePreview" 
                    data="" 
                    type="application/pdf" 
                    width="100%" 
                    height="600px" 
                    style="display: none;">
                <p>Unable to display PDF file. <a id="fallbackLink" href="" target="_blank">Download</a> instead.</p>
            </object>
            <!-- For Images -->
            <img id="imagePreview" style="display: none;">
        </div>
    </div>
</div>

<script>
    function previewFile(fileUrl) {
        const modal = document.getElementById('previewModal');
        const objectPreview = document.getElementById('filePreview');
        const imagePreview = document.getElementById('imagePreview');
        const fallbackLink = document.getElementById('fallbackLink');
        
        // Check file type based on extension
        const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(fileUrl);
        const isPDF = /\.pdf$/i.test(fileUrl);
        
        if (isImage) {
            // Handle image files
            imagePreview.src = fileUrl;
            imagePreview.style.display = 'block';
            objectPreview.style.display = 'none';
        } else if (isPDF) {
            // Handle PDF files
            objectPreview.data = fileUrl;
            fallbackLink.href = fileUrl;
            objectPreview.style.display = 'block';
            imagePreview.style.display = 'none';
        }
        
        modal.style.display = 'block';
    }

    document.querySelector('.close-modal').onclick = function() {
        const modal = document.getElementById('previewModal');
        const objectPreview = document.getElementById('filePreview');
        const imagePreview = document.getElementById('imagePreview');
        
        modal.style.display = 'none';
        // Clear the sources when closing
        objectPreview.data = '';
        imagePreview.src = '';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('previewModal');
        if (event.target == modal) {
            const objectPreview = document.getElementById('filePreview');
            const imagePreview = document.getElementById('imagePreview');
            
            modal.style.display = 'none';
            // Clear the sources when closing
            objectPreview.data = '';
            imagePreview.src = '';
        }
    }
</script>
{% endblock %}

{% block messages %}{% endblock %}
