{% extends 'mainv2.html' %}
{% load static tailwind_tags %}

{% block title %}HealthHub Connect | Mental Health Records{% endblock %}

{% block extra_css %}
{% tailwind_css %}
<style>
    /* Add any specific styles for the admin mental health view here */
    /* Keep the modal styles from medupload.html for consistency */

    /* Modal styles copied from medupload.html */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow: auto; /* Allow scrolling for modal itself if content is large */
        padding: 20px; /* Adjust padding for better spacing */
        box-sizing: border-box; /* Include padding in element's total width and height */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 20px auto; /* Adjust margin for centering and spacing */
        padding: 20px;
        border: 1px solid #888;
        width: 95%; /* Increase width slightly */
        max-width: 1000px; /* Increase max-width */
        border-radius: 8px;
        position: relative;
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 40px); /* Limit modal content height, considering modal padding */
        box-sizing: border-box; /* Include padding in element's total width and height */
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px; /* Add padding below header */
        border-bottom: 1px solid #eee; /* Add a subtle separator */
    }
    .modal-title {
        font-size: 1.5rem; /* Larger title font size */
        font-weight: bold;
    }
    .close-modal {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    #previewContainer {
        flex-grow: 1;
        width: 100%;
        overflow: auto; /* Allow scrolling within preview area */
        text-align: center;
        /* Max height relative to the modal content height, considering header/footer */
        max-height: calc(100% - 70px); /* Approximation based on header+footer height */
        padding-top: 10px; /* Add some space above preview content */
    }
    #previewContainer img,
    #previewContainer object {
        display: block; /* Prevent extra space below inline elements */
        max-width: 100%;
        height: auto; /* Maintain aspect ratio */
        margin: auto; /* Center image/object */
        transform-origin: top left; /* Set transform origin for zooming */
    }
     #previewContainer object {
        width: 100%; /* Allow object to take full width of container if needed */
        height: 100%; /* Allow object to take full height of container if needed */
     }
    .zoom-controls {
        margin-top: 10px;
        padding-top: 10px; /* Add padding above controls */
        border-top: 1px solid #eee; /* Add a subtle separator */
        text-align: center;
        flex-shrink: 0; /* Prevent controls from shrinking */
    }
    .zoom-controls button {
        padding: 8px 16px;
        margin: 0 5px;
        cursor: pointer;
        background-color: #3b82f6; /* Blue background */
        color: white; /* White text */
        border: none;
        border-radius: 4px; /* Rounded corners */
        font-size: 1rem; /* Readable font size */
        transition: background-color 0.3s ease; /* Smooth hover effect */
    }
    .zoom-controls button:hover {
        background-color: #2563eb; /* Darker blue on hover */
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white xs:h-fit md:h-full xs:p-4 lg:p-8 flex flex-col gap-6 rounded-[18px] xs:w-full md:w-auto shadow-lg">
    <h2 class="font-bold text-[1.5rem] text-black tracking-tight text-center mb-2">Mental Health Records</h2>

    <!-- Mental Health Records List Section -->
    <div class="bg-[#f8fafc] rounded-lg p-4 mb-6 border border-gray-200 w-full">
        <h3 class="font-semibold text-blue-700 mb-4">Mental Health Records List</h3>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="student-tab" class="px-4 py-2 -mb-px text-sm font-medium text-center text-blue-700 bg-transparent border-b-2 border-blue-700 sm:text-base dark:text-blue-500 dark:border-blue-500 focus:outline-none" type="button" role="tab" aria-controls="student-list" aria-selected="true">Students</button>
            <button id="faculty-tab" class="px-4 py-2 -mb-px text-sm font-medium text-center text-gray-500 bg-transparent border-b-2 border-transparent sm:text-base dark:text-gray-400 dark:border-gray-700 hover:text-gray-700 hover:border-gray-300 dark:hover:text-gray-300 focus:outline-none" type="button" role="tab" aria-controls="faculty-list" aria-selected="false">Faculty</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content" class="mt-4">
            <!-- Student List -->
            <div id="student-list" class="tab-pane" role="tabpanel" aria-labelledby="student-tab">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Number</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% comment %} Loop through student mental health records here {% endcomment %}
                            {% for record in student_mhr_list %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.student_id_display }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.student_name_display }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.status|title }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No student mental health records found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Faculty List -->
            <div id="faculty-list" class="tab-pane hidden" role="tabpanel" aria-labelledby="faculty-tab">
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Number</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% comment %} Loop through faculty mental health records here {% endcomment %}
                             {% for record in faculty_mhr_list %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.faculty.faculty_id }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.faculty.user.get_full_name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ record.status|title }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No faculty mental health records found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Submitted Records (Existing Search Section) -->
    <div class="bg-[#f8fafc] rounded-lg p-4 mb-2 border border-gray-200 w-full">
        <h3 class="font-semibold text-blue-700 mb-2">Submitted Records</h3>
        <div class="mb-4 p-3 bg-blue-50 rounded-md border border-blue-100">
            <p class="text-sm text-blue-800">Search for a student or faculty by ID to review and manage their mental health record. There are <span class="font-bold">{{ pending_count }}</span> pending records overall.</p>
        </div>
        
        <!-- Student/Faculty ID Search Form -->
        <form method="GET" action="{% url 'medical:mental_health' %}" class="mb-4">
            <div class="flex items-center">
                <input type="text" name="search_id" placeholder="Enter ID Number" class="border border-gray-300 rounded-l-md py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 flex-grow" value="{{ search_id|default:'' }}">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-r-md hover:bg-blue-600 transition-colors">Search</button>
            </div>
        </form>

        {% if fetched_mental_health_record %}
            {% if fetched_student %}
                <h4 class="font-semibold text-lg text-gray-800 mb-4">Record for: {{ fetched_student.firstname }} {{ fetched_student.lastname }} ({{ fetched_student.student_id }})</h4>
            {% elif fetched_faculty %}
                <h4 class="font-semibold text-lg text-gray-800 mb-4">Record for: {{ fetched_faculty.user.get_full_name }} ({{ fetched_faculty.faculty_id }})</h4>
            {% endif %}

            <form method="POST" action="{% url 'medical:mental_health' %}">
                {% csrf_token %}
                <!-- Include search_id to maintain search context after POST -->
                {% if search_id %}
                <input type="hidden" name="search_id" value="{{ search_id }}">
                {% endif %}
                <!-- Include the primary key of the mental health record for updates -->
                <input type="hidden" name="record_id" value="{{ fetched_mental_health_record.pk }}">

                <div class="table-container">
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto border-separate border-spacing-0 rounded-lg overflow-hidden shadow">
                            <thead class="bg-[#e6e6e6]">
                                <tr>
                                    <th class="p-2 text-left">Document Type</th>
                                    <th class="p-2 text-center">File</th>
                                    <th class="p-2 text-left">Remarks</th>
                                    <th class="p-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Prescription Row -->
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="p-2 font-medium">Prescription</td>
                                    <td class="p-2 text-center">
                                        {% if fetched_mental_health_record.prescription %}
                                            <button type="button" onclick="previewFile('{{ fetched_mental_health_record.prescription.url }}', '{% if fetched_student %}{{ fetched_student.firstname }} {{ fetched_student.lastname }}{% elif fetched_faculty %}{{ fetched_faculty.user.get_full_name }}{% endif %}', 'Prescription')" class="text-blue-600 hover:underline">Preview</button>
                                        {% else %}
                                            <span class="text-gray-400">No file uploaded</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-2">
                                        <textarea name="prescription_remarks" class="border border-gray-300 rounded-md p-2 w-full resize-none" rows="3">{{ fetched_mental_health_record.prescription_remarks|default:'' }}</textarea>
                                    </td>
                                    <td class="p-2 text-center" rowspan="2">{{ fetched_mental_health_record.status|title }}</td>
                                </tr>
                                <!-- Certification Row -->
                                <tr class="bg-white hover:bg-gray-50">
                                    <td class="p-2 font-medium">Certification</td>
                                    <td class="p-2 text-center">
                                        {% if fetched_mental_health_record.certification %}
                                            <button type="button" onclick="previewFile('{{ fetched_mental_health_record.certification.url }}', '{% if fetched_student %}{{ fetched_student.firstname }} {{ fetched_student.lastname }}{% elif fetched_faculty %}{{ fetched_faculty.user.get_full_name }}{% endif %}', 'Certification')" class="text-blue-600 hover:underline">Preview</button>
                                        {% else %}
                                            <span class="text-gray-400">No file uploaded</span>
                                        {% endif %}
                                    </td>
                                    <td class="p-2">
                                        <textarea name="certification_remarks" class="border border-gray-300 rounded-md p-2 w-full resize-none" rows="3">{{ fetched_mental_health_record.certification_remarks|default:'' }}</textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-4 flex justify-center space-x-4">
                    <!-- Changed value to save_remarks to match view logic -->
                    <button type="submit" name="action" value="save_remarks" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">Save Remarks</button>
                    <!-- Changed value to approved to match view logic -->
                    <button type="submit" name="action" value="approved" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">Approve Record</button>
                    <!-- Changed value to rejected to match view logic -->
                    <button type="submit" name="action" value="rejected" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors">Reject Record</button>
                </div>
            </form>

        {% elif search_id %}
            <p class="text-center text-gray-600">No record found for ID Number: {{ search_id }}</p>
        {% else %}
            <p class="text-center text-gray-600">Please enter an ID to search for a mental health record.</p>
        {% endif %}

    </div>
</div>

<!-- Modal Structure (copied from medupload.html) -->
<div id="previewModal" class="modal">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">File Preview</h5>
            <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div id="previewContainer"></div>
        <div class="zoom-controls">
            <button onclick="zoomOut()">-</button>
            <button onclick="zoomIn()">+</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // JavaScript for modal and zoom functionality (copied from medupload.html, adapted)

    let currentZoom = 1.0; // Initial zoom level
    const zoomStep = 0.1; // How much to zoom in/out by

    function previewFile(fileUrl, studentName, documentType) {
        const modal = document.getElementById('previewModal');
        const previewContainer = document.getElementById('previewContainer');
        const modalTitle = document.getElementById('modalTitle');
        
        // Clear previous content
        previewContainer.innerHTML = '';
        
        modalTitle.textContent = `Preview: ${studentName} - ${documentType}`;

        const isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
        const isPDF = /\.pdf$/i.test(fileUrl);
        
        if (isImage) {
            const img = document.createElement('img');
            img.id = 'imagePreview';
            img.src = fileUrl;
            img.style.maxWidth = '100%'; // Ensure image doesn't overflow initially
            img.style.height = 'auto';
            previewContainer.appendChild(img);
             currentZoom = 1.0; // Reset zoom for new image
             img.style.transform = `scale(${currentZoom})`;

        } else if (isPDF) {
            const obj = document.createElement('object');
            obj.id = 'filePreview';
            obj.data = fileUrl;
            obj.type = 'application/pdf';
            obj.style.width = '100%'; // PDF object can take full width
            obj.style.height = '100%'; // PDF object can take full height
             // For PDFs, embedding might not support direct CSS zoom. Fallback to link or iframe.
             // For simplicity and consistency with admin, let's use an iframe if object fails or for better control
             // Or keep object and note zoom might not work depending on browser/PDF viewer
            const fallbackLink = document.createElement('p');
            fallbackLink.innerHTML = `Unable to display PDF file. <a href="${fileUrl}" target="_blank">Download</a> instead.`;
            obj.appendChild(fallbackLink);

             previewContainer.appendChild(obj);
            currentZoom = 1.0; // Reset zoom for new PDF
            // Note: CSS transform might not work reliably on <object> or <iframe> for PDFs
            // If true PDF zoom is needed, consider a library or server-side rendering approach.
            // For now, the zoom buttons will be added but might not affect the PDF object depending on the browser.
             obj.style.transform = `scale(${currentZoom})`; // Apply transform, but manage expectations for PDFs
        }
        
        modal.style.display = 'block';
        // Hide body scrollbars when modal is open
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('previewModal');
        modal.style.display = 'none';
        // Show scrollbars again
        document.body.style.overflow = 'auto';
         currentZoom = 1.0; // Reset zoom when closing modal
    }

    // Close modal when clicking outside the modal-content
    window.onclick = function(event) {
        const modal = document.getElementById('previewModal');
        const modalContent = document.querySelector('.modal-content');
        // Check if the clicked area is outside the modal-content but inside the modal
        if (event.target === modal) {
            closeModal();
        }
    }

    function zoomIn() {
        currentZoom += zoomStep;
        applyZoom();
    }

    function zoomOut() {
        currentZoom = Math.max(zoomStep, currentZoom - zoomStep); // Prevent zooming out to zero or negative
        applyZoom();
    }

    function applyZoom() {
        const imageElement = document.getElementById('imagePreview');
        const objectElement = document.getElementById('filePreview');

        if (imageElement) {
            imageElement.style.transform = `scale(${currentZoom})`;
             // Adjust transform origin if needed, currently set to top left in CSS
        } else if (objectElement) {
            // Applying transform to object element (for PDFs) - behavior may vary across browsers
             // Consider alternative PDF viewers for reliable zoom
            objectElement.style.transform = `scale(${currentZoom})`;
             // You might need to adjust the container's overflow and dimensions if zooming causes content to exceed boundaries
        }
         // You might also want to update a visual indicator of the current zoom level
    }

    // JavaScript for tab switching
    document.addEventListener('DOMContentLoaded', function () {
        const studentTab = document.getElementById('student-tab');
        const facultyTab = document.getElementById('faculty-tab');
        const studentList = document.getElementById('student-list');
        const facultyList = document.getElementById('faculty-list');

        function activateTab(tabButton, contentPane) {
            // Deactivate all tabs and hide all content panes
            document.querySelectorAll('.flex.border-b button').forEach(btn => {
                btn.classList.remove('border-blue-700', 'text-blue-700');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });

            // Activate the selected tab and show the corresponding content pane
            tabButton.classList.add('border-blue-700', 'text-blue-700');
            tabButton.classList.remove('border-transparent', 'text-gray-500');
            contentPane.classList.remove('hidden');
        }

        studentTab.addEventListener('click', function () {
            activateTab(studentTab, studentList);
        });

        facultyTab.addEventListener('click', function () {
            activateTab(facultyTab, facultyList);
        });

        // Activate the student tab by default on page load
        activateTab(studentTab, studentList);
    });

</script>
{% endblock %}
