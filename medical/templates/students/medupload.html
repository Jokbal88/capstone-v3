{% extends 'mainv2.html' %}
{% load static tailwind_tags %}
{% block title %}HealthHub Connect | Medical Requirements Upload{% endblock %}
{% block extra_css %}
{% tailwind_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
        position: relative;
    }
    .close-modal {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    #previewContainer {
        width: 100%;
        height: 80vh;
        overflow: auto;
    }
    #previewContainer img {
        max-width: 100%;
        height: auto;
    }
    #previewContainer object {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white xs:h-fit md:h-full xs:p-4 lg:p-8 flex flex-col gap-6 rounded-[18px] xs:w-full md:w-auto shadow-lg">
    <h2 class="font-bold text-[1.5rem] text-black tracking-tight text-center mb-2">Upload Medical Requirements</h2>
    <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-1">
            <label for="student_id" class="font-semibold text-gray-700">Student ID</label>
            <input class="w-full xs:text-[14px] md:text-base bg-gray-100 rounded-md px-3 py-2" type="text" id="student_id" name="student_id" value="{{ user.username }}" readonly>
        </div>
        <div class="bg-[#f8fafc] rounded-lg p-4 mb-2 border border-gray-200">
            <h3 class="font-semibold text-blue-700 mb-2">Required Medical Documents</h3>
            <div class="mb-4 p-3 bg-blue-50 rounded-md border border-blue-100">
                <p class="text-sm text-blue-800">Please submit all required medical documents. These are essential for ensuring the health and safety of all students.</p>
            </div>
            <table class="w-full table-auto border-separate border-spacing-0 rounded-lg overflow-hidden shadow">
                <thead class="bg-[#e6e6e6]">
                    <tr>
                        <th class="p-2 text-center">Remarks</th>
                        <th class="p-2 text-center">Requirement Type</th>
                        <th class="p-2 text-center">File</th>
                        <th class="p-2 text-center">Status</th>
                        <th class="p-2 text-center">Upload</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requirements %}
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="p-2 text-center">
                            {% if md %}
                                {% if req.slug == 'chest_xray' %}{{ md.x_ray_remarks|default:'None' }}
                                {% elif req.slug == 'cbc' %}{{ md.cbc_remarks|default:'None' }}
                                {% elif req.slug == 'drug_test' %}{{ md.drug_test_remarks|default:'None' }}
                                {% elif req.slug == 'stool_examination' %}{{ md.stool_examination_remarks|default:'None' }}
                                {% elif req.slug == 'pwd_card' %}{{ md.pwd_card_remarks|default:'None' }}
                                {% else %}None{% endif %}
                            {% else %}None{% endif %}
                        </td>
                        <td class="p-2 font-medium text-center">{{ req.name }}</td>
                        <td class="p-2 text-center">
                            {% if md %}
                                {% if req.slug == 'chest_xray' and md.chest_xray %}
                                    <button onclick="previewFile('{{ md.chest_xray.url }}')" class="text-blue-600 hover:underline">Preview</button>
                                {% elif req.slug == 'cbc' and md.cbc %}
                                    <button onclick="previewFile('{{ md.cbc.url }}')" class="text-blue-600 hover:underline">Preview</button>
                                {% elif req.slug == 'drug_test' and md.drug_test %}
                                    <button onclick="previewFile('{{ md.drug_test.url }}')" class="text-blue-600 hover:underline">Preview</button>
                                {% elif req.slug == 'stool_examination' and md.stool_examination %}
                                    <button onclick="previewFile('{{ md.stool_examination.url }}')" class="text-blue-600 hover:underline">Preview</button>
                                {% elif req.slug == 'pwd_card' and md.pwd_card %}
                                    <button onclick="previewFile('{{ md.pwd_card.url }}')" class="text-blue-600 hover:underline">Preview</button>
                                {% else %}
                                    <span class="text-gray-400">None</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400">None</span>
                            {% endif %}
                        </td>
                        <td class="p-2 text-center">
        {% if md %}
                                {% if req.slug == 'chest_xray' and md.chest_xray %}
                                    <span class="text-green-600 text-xl">&#10003;</span>
                                {% elif req.slug == 'cbc' and md.cbc %}
                                    <span class="text-green-600 text-xl">&#10003;</span>
                                {% elif req.slug == 'drug_test' and md.drug_test %}
                                    <span class="text-green-600 text-xl">&#10003;</span>
                                {% elif req.slug == 'stool_examination' and md.stool_examination %}
                                    <span class="text-green-600 text-xl">&#10003;</span>
                                {% elif req.slug == 'pwd_card' and md.pwd_card %}
                                    <span class="text-green-600 text-xl">&#10003;</span>
                                {% else %}
                                    <span class="text-red-500 text-xl">&#10007;</span>
            {% endif %}
                            {% else %}
                                <span class="text-gray-400">None</span>
        {% endif %}
                        </td>
                        <td class="p-2 flex justify-center">
                            {% if md %}
                                <form method="POST" enctype="multipart/form-data" class="flex items-center">
                                    {% csrf_token %}
                                    <input type="hidden" name="student_id" value="{{ user.username }}">
                                    <input type="hidden" name="requirement_type" value="{{ req.slug }}">
                                    <input type="file" name="file" class="file-input file-input-bordered file-input-sm w-full" accept=".pdf,.jpg,.jpeg,.png" required>
                                    <button type="submit" class="bg-[#3b82f6] text-white py-1 px-3 rounded-md font-semibold hover:bg-[#2563eb] transition-colors">Upload</button>
                                </form>
                            {% else %}
                                <form method="POST">
            {% csrf_token %}
                                    <input type="hidden" name="student_id" value="{{ user.username }}">
                                    <input type="hidden" name="requirement_type" value="{{ req.slug }}">
                                    <button type="submit" class="bg-[#3b82f6] text-white py-1 px-3 rounded-md font-semibold hover:bg-[#2563eb] transition-colors">Submit</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            </div>
            </div>

<!-- Add Modal for File Preview -->
<div id="previewModal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="previewContainer">
            <!-- For PDFs -->
            <object id="filePreview" 
                    data="" 
                    type="application/pdf" 
                    width="100%" 
                    height="100%" 
                    style="display: none;">
                <p>Unable to display PDF file. <a id="fallbackLink" href="" target="_blank">Download</a> instead.</p>
            </object>
            <!-- For Images -->
            <img id="imagePreview" style="display: none;">
            </div>
            </div>
</div>

<script>
    function previewFile(fileUrl) {
        const modal = document.getElementById('previewModal');
        const objectPreview = document.getElementById('filePreview');
        const imagePreview = document.getElementById('imagePreview');
        const fallbackLink = document.getElementById('fallbackLink');
        
        // Check file type based on extension
        const isImage = /\.(jpg|jpeg|png)$/i.test(fileUrl);
        const isPDF = /\.pdf$/i.test(fileUrl);
        
        if (isImage) {
            // Handle image files
            imagePreview.src = fileUrl;
            imagePreview.style.display = 'block';
            objectPreview.style.display = 'none';
        } else if (isPDF) {
            // Handle PDF files
            objectPreview.data = fileUrl;
            fallbackLink.href = fileUrl;
            objectPreview.style.display = 'block';
            imagePreview.style.display = 'none';
        }
        
        modal.style.display = 'block';
    }

    // Close modal when clicking the X
    document.querySelector('.close-modal').onclick = function() {
        document.getElementById('previewModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('previewModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}
