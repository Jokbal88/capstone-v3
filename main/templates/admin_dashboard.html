{% extends 'mainv2.html' %} 
{% load static tailwind_tags %} 

{% block title %}HealthHub Connect | Admin Dashboard{% endblock %}

{% block extra_css %} 
<style>
    html, body, #__next, main, .admin-dashboard-container {
        height: 100%;
        min-height: 100vh;
    }
    .admin-dashboard-container {
        width: 100vw;
        min-height: 100vh;
        background: #fff;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        display: flex;
        flex-direction: column;
    }
    .dashboard-main-grid {
        display: grid;
        grid-template-columns: 1fr; /* Changed to a single column */
        gap: 2rem;
        flex: 1;
        height: 100%;
        align-items: stretch;
    }
    .dashboard-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);
        padding: 1.5rem;
        margin-bottom: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s;
    }
    .dashboard-card:hover {
        box-shadow: 0 4px 16px 0 rgba(59,130,246,0.10);
    }
    .dashboard-table th {
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.95rem;
        color: #374151;
        background: #fff; /* Ensure a solid background for sticky header */
        letter-spacing: 0.04em;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    .dashboard-table thead, .dashboard-table tbody {
        display: block;
    }
    .dashboard-table tbody {
        max-height: calc(70vh - 120px); /* Adjust based on actual header heights */
        overflow-y: auto;
    }
    .dashboard-table tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    .dashboard-table th, .dashboard-table td {
        width: calc(100% / 5); /* Assuming 5 columns */
    }
    .dashboard-table td {
        font-size: 1rem;
        color: #222;
        background: #fff;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        white-space: nowrap; /* Keep text on one line */
        overflow: hidden; /* Hide overflow content */
        text-overflow: ellipsis; /* Add ellipsis for overflowed text */
    }
    .dashboard-table tbody tr:hover {
        background-color: #f0f4f8; /* Light gray-blue on hover */
    }
    .calendar-admin {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 4px 0 rgba(0,0,0,0.06);
        padding: 1rem;
        border: 1px solid #e5e7eb;
    }
    .calendar-header-admin {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        margin-bottom: 0.5rem;
    }
    .calendar-header-cell-admin {
        text-align: center;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6B7280;
        padding: 0.25rem;
    }
    #calendarDaysAdmin {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: repeat(6, 1fr);
        gap: 2px;
    }
    .calendar-day-admin {
        aspect-ratio: 1;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        color: #374151;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        position: relative;
        min-height: 32px;
    }
    .calendar-day-admin:hover:not(.empty-day) {
        background: #e0e7ff;
        color: #1d4ed8;
        font-weight: 600;
    }
    .calendar-day-admin.today {
        background-color: #3B82F6;
        color: white;
        font-weight: 700;
        border: 1.5px solid #2563eb;
    }
    .calendar-day-admin.empty-day {
        cursor: default;
        background: #fff;
        border: none;
    }
    .calendar-day-admin.has-approved-event {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #34d399;
    }
    .calendar-day-admin.has-pending-event {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
    }
    .calendar-day-admin.has-both-events {
        background: linear-gradient(135deg, #d1fae5 50%, #fef3c7 50%);
        color: #065f46;
        border: 1px solid #34d399;
    }
    .calendar-day-admin.has-emergency-event {
        background: #fbe6e6; /* Lighter red */
        color: #c53030; /* Darker red */
        border: 1px solid #f68787;
    }
    .calendar-day-admin.has-completed-event {
        background: #e0f2fe; /* Lighter blue */
        color: #2b6cb0; /* Darker blue */
        border: 1px solid #90cdf4;
    }
    .calendar-day-admin.has-event::after {
        content: '';
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: currentColor;
    }
    @media (max-width: 1024px) {
        .dashboard-main-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Tab styles */
    .tab-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    
    .tab-buttons::-webkit-scrollbar {
        display: none;
    }
    
    .tab-button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.875rem;
        flex-shrink: 0;
    }
    
    .tab-button:hover {
        background-color: #f3f4f6;
        color: #374151;
    }
    
    .tab-button.active {
        background-color: #3b82f6;
        color: white;
    }
    
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    
    .status-badge.pending {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .status-badge.approved {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-badge.rejected {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .status-badge.emergency {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .status-badge.completed {
        background-color: #dbeafe;
        color: #1e40af;
    }

    /* New style for requests table scroll */
    .requests-table-scroll {
        max-height: 70vh; /* Adjust this value as needed to show more lists */
        overflow-y: auto;
        /* overflow: visible; */ /* Ensure it does not create a new stacking context for sticky headers */
    }

    /* New style for Requests Section sticky header */
    .requests-header-sticky-container {
        position: sticky;
        top: 0;
        z-index: 999; /* Ensure it's above other content */
        background-color: #fff; /* Match background for seamless look */
        padding-top: 1rem;
        padding-bottom: 1rem;
        margin-bottom: 1rem; /* Space between header and content */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* Optional subtle shadow */
        border-radius: 12px; /* Apply border-radius for consistency with dashboard-card */
        isolation: isolate; /* Ensures a new stacking context */
    }

    /* New style for scrollable table body */
    .table-body-scroll {
        max-height: calc(100vh - 250px); /* Adjust based on actual header heights */
        overflow-y: auto;
    }

    /* SweetAlert2 custom button styles */
    .swal2-confirm-button {
        @apply bg-blue-500 text-white hover:bg-blue-600;
    }
    .swal2-deny-button {
        @apply bg-purple-500 text-white hover:bg-purple-600;
    }
    .swal2-cancel-button {
        @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
    }
</style>
{% endblock %} 

{% block content %}
<div class="flex flex-col bg-white rounded-[14px] h-min w-full p-4">
    <div class="flex flex-col gap-4 h-auto">
        <div class="flex flex-row gap-4 w-full">
            <div class="calendar-admin flex-1 flex flex-col justify-end">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-base font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-blue-400"></i> Calendar
                    </span>
                    <div class="flex items-center gap-2">
                        <button onclick="previousMonthAdmin()" class="text-gray-500 hover:text-blue-600 transition p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-200">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentMonthAdmin" class="px-4 py-1 bg-blue-50 text-blue-700 rounded-full font-semibold text-sm shadow-sm border border-blue-100" style="min-width:120px; text-align:center;"></span>
                        <button onclick="nextMonthAdmin()" class="text-gray-500 hover:text-blue-600 transition p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-200">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="calendar-header-admin">
                    <div class="calendar-header-cell-admin">Sun</div>
                    <div class="calendar-header-cell-admin">Mon</div>
                    <div class="calendar-header-cell-admin">Tue</div>
                    <div class="calendar-header-cell-admin">Wed</div>
                    <div class="calendar-header-cell-admin">Thu</div>
                    <div class="calendar-header-cell-admin">Fri</div>
                    <div class="calendar-header-cell-admin">Sat</div>
                </div>
                <div id="calendarDaysAdmin"></div>
            </div>
            <div class="flex flex-col flex-1">
                <span class="font-bold text-gray-700 mr-4"> Additional Actions:</span>
                <div class="grid grid-cols-2 gap-2">
                    <a href="#" onclick="addPatientPrompt(event)" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition text-center">Onsite Registration</a>
                    <a href="#" onclick="sendFacultyRegistrationLinkPrompt(event)" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 transition text-center">Online Faculty Registration</a>
                    <a href="{% url 'medical:upload_requirements' %}" class="bg-purple-500 text-white p-2 rounded-md hover:bg-purple-600 transition text-center">Upload Document</a>
                    <a href="mailto:" class="bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600 transition text-center">Send Notification</a>
                </div>
                <div class="flex flex-col justify-center items-center flex-[2] bg-white rounded-xl shadow border border-blue-100 ml-auto p-8 w-full text-center">
                    <div id="adminLiveTime" class="text-5xl font-extrabold text-blue-700 mb-2"></div>
                    <div id="adminLiveDate" class="text-base font-semibold text-gray-600"></div>
                    <div class="flex flex-row justify-center items-center gap-4 mt-4">
                        <div class="flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                            <i class="fas fa-calendar-check text-purple-500 text-xl"></i>
                            <span class="text-xs text-gray-500">Today's Schedule</span>
                            <span class="text-2xl font-bold text-purple-600">{{ todays_schedule|default:0 }}</span>
                        </div>
                        <div class="flex flex-col items-center p-2 bg-gray-50 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                            <span class="text-xs text-gray-500">Urgent Cases</span>
                            <span class="text-2xl font-bold text-red-600">{{ urgent_cases|default:0 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex gap-4 bg-gray-50 rounded-xl border border-gray-200 items-stretch">
            <div class="flex-1 dashboard-card flex flex-col items-center justify-center text-center shadow-none border-none bg-transparent hover:shadow-none">
                <i class="fas fa-users text-blue-500 text-xl mb-1"></i>
                <span class="text-xs text-gray-500 mb-1">Total Patients</span>
                <span class="text-2xl font-bold text-blue-600">{{ total_patients }}</span>
        </div>
            <div class="flex-1 dashboard-card flex flex-col items-center justify-center text-center shadow-none border-none bg-transparent hover:shadow-none">
                <i class="fas fa-file-medical text-green-500 text-xl mb-1"></i>
                <span class="text-xs text-gray-500 mb-1">Total Records</span>
                <span class="text-2xl font-bold text-green-600">{{ total_records|default:0 }}</span>
        </div>
            <div class="flex-1 dashboard-card flex flex-col items-center justify-center text-center shadow-none border-none bg-transparent hover:shadow-none">
                <i class="fas fa-clock text-yellow-500 text-xl mb-1"></i>
                <span class="text-xs text-gray-500 mb-1">Pending Requests</span>
                <span class="text-2xl font-bold text-yellow-600">{{ pending_requests|default:0 }}</span>
        </div>
        </div>
        <div class="dashboard-main-grid">
            <!-- Left Column: Requests Card with Tabs -->
            <div class="dashboard-card border border-gray-200 flex-1 flex flex-col mb-2 w-full">
                <div class="requests-header-sticky-container px-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Requests Section</h3>
                    <div class="tab-buttons">
                        <button class="tab-button {% if active_tab == 'all' %}active{% endif %}" data-tab="all">
                            All Requests
                        </button>
                        <button class="tab-button {% if active_tab == 'documentary' %}active{% endif %}" data-tab="documentary">
                            Documentary
                        </button>
                        <button class="tab-button {% if active_tab == 'dental' %}active{% endif %}" data-tab="dental">
                            Dental
                        </button>
                        <button class="tab-button {% if active_tab == 'emergency' %}active{% endif %}" data-tab="emergency">
                            Emergency
                        </button>
                        <button class="tab-button {% if active_tab == 'mental' %}active{% endif %}" data-tab="mental">
                            Mental Health
                        </button>
                    </div>
                    <input type="text" id="requestSearch" onkeyup="filterRequests()" placeholder="Search requests by ID, name, or type..." 
                           class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mt-4 mb-4">
                </div>
                <div class="overflow-x-auto flex-1 requests-table-scroll p-4">
                    <table class="min-w-full dashboard-table">
                            <thead style="background-color: #fff;">
                            <tr>
                                <th class="px-4 py-2">ID</th>
                                <th class="px-4 py-2">Name</th>
                                <th class="px-4 py-2">Request Type</th>
                                <th class="px-4 py-2">Date</th>
                                <th class="px-4 py-2">Status</th>
                                <!-- Removed Actions Header -->
                                </tr>
                            </thead>
                            <tbody>
                            {% for request_data in all_upcoming_requests %}
                            <tr class="request-row" data-type="{{ request_data.type }}">
                                <td class="px-4 py-2 text-center">{{ request_data.user_info.id }}</td>
                                <td class="px-4 py-2">{{ request_data.user_info.name }}</td>
                                <td class="px-4 py-2">
                                    {% if request_data.type == 'documentary' %}
                                        {{ request_data.request.request_type }}
                                    {% elif request_data.type == 'dental' %}
                                        {{ request_data.request.service_type }}
                                    {% elif request_data.type == 'emergency' %}
                                        Emergency Assistance
                                    {% elif request_data.type == 'mental' %}
                                        Mental Health Consultation
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2">
                                    {% if request_data.type == 'emergency' %}
                                        {{ request_data.request.date_assisted }}
                                    {% elif request_data.type == 'mental' %}
                                        {{ request_data.request.date_submitted|date:"F d, Y" }}
                                    {% else %}
                                        {{ request_data.request.date_requested|date:"F d, Y" }}
                                    {% endif %}
                                </td>
                                <td class="px-4 py-2 text-center">
                                    {% if request_data.type == 'emergency' %}
                                        <span class="status-badge emergency">Emergency</span>
                                    {% elif request_data.type == 'dental' %}
                                        <span class="status-badge {% if request_data.request.appointed %}completed{% else %}pending{% endif %}">
                                            {% if request_data.request.appointed %}Completed{% else %}Pending{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="status-badge {{ request_data.request.status }}">
                                            {{ request_data.request.status|title }}
                                        </span>
                                    {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                <td colspan="5" class="px-4 py-2 text-center">No requests found</td>
          </tr>
                                {% endfor %}
        </tbody>
      </table>
    </div>
                </div>
      </div>
        </div>
</div>

<!-- Pass Django events to JS safely -->
{{ events|json_script:"admin-events-data" }}

<script>
function updateAdminLiveTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const dateString = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('adminLiveTime').textContent = timeString;
    document.getElementById('adminLiveDate').textContent = dateString;
}
setInterval(updateAdminLiveTime, 1000);
document.addEventListener('DOMContentLoaded', updateAdminLiveTime);

// Correctly parse events from Django context, ensuring it's an array
const events = JSON.parse(document.getElementById('admin-events-data').textContent || '[]');

let currentDateAdmin = new Date();
const monthNamesAdmin = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
];

function updateCalendarAdmin() {
    const calendar = document.getElementById('calendarDaysAdmin');
    const monthLabel = document.getElementById('currentMonthAdmin');
    calendar.innerHTML = '';
    monthLabel.textContent = `${monthNamesAdmin[currentDateAdmin.getMonth()]} ${currentDateAdmin.getFullYear()}`;
    
    const firstDay = new Date(currentDateAdmin.getFullYear(), currentDateAdmin.getMonth(), 1);
    const startingDay = firstDay.getDay();
    const lastDay = new Date(currentDateAdmin.getFullYear(), currentDateAdmin.getMonth() + 1, 0);
    const totalDays = lastDay.getDate();

    // Add empty cells for days before the first day of the month
    for (let i = 0; i < startingDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day-admin empty-day';
        calendar.appendChild(emptyCell);
    }

    // Add the days of the month
    for (let day = 1; day <= totalDays; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-day-admin';
        
        // Create date string for comparison
        const dateString = `${currentDateAdmin.getFullYear()}-${String(currentDateAdmin.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // Check for events on this day
        const dayEvents = events.filter(event => event.date === dateString);
        if (dayEvents.length > 0) {
            const hasApproved = dayEvents.some(event => event.status === 'approved');
            const hasPending = dayEvents.some(event => event.status === 'pending');
            const hasEmergency = dayEvents.some(event => event.status === 'emergency');
            const hasCompleted = dayEvents.some(event => event.status === 'completed');
            
            if (hasApproved && hasPending) {
                cell.className += ' has-both-events';
            } else if (hasApproved) {
                cell.className += ' has-approved-event';
            } else if (hasPending) {
                cell.className += ' has-pending-event';
            } else if (hasEmergency) {
                cell.className += ' has-emergency-event'; 
            } else if (hasCompleted) {
                cell.className += ' has-completed-event'; 
            }
        }

        // Highlight current day
        const today = new Date();
        if (day === today.getDate() &&
            currentDateAdmin.getMonth() === today.getMonth() &&
            currentDateAdmin.getFullYear() === today.getFullYear()) {
            cell.className += ' today';
        }

        cell.textContent = day;
        calendar.appendChild(cell);
    }

    // Add empty cells for remaining days to complete the grid
    const remainingDays = 42 - (startingDay + totalDays);
    for (let i = 0; i < remainingDays; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day-admin empty-day';
        calendar.appendChild(emptyCell);
    }
}

function previousMonthAdmin() {
    currentDateAdmin.setMonth(currentDateAdmin.getMonth() - 1);
    updateCalendarAdmin();
}

function nextMonthAdmin() {
    currentDateAdmin.setMonth(currentDateAdmin.getMonth() + 1);
    updateCalendarAdmin();
}

// Initial calendar rendering on page load
document.addEventListener('DOMContentLoaded', () => {
    updateCalendarAdmin();
    updateAdminLiveTime();
});

// Tab switching functionality
(function() {
    const adminTabButtons = document.querySelectorAll('.dashboard-card .tab-button');
    const adminRequestRows = document.querySelectorAll('.dashboard-card .request-row');
    
    function switchAdminTab(tabName) {
        // Update URL without reloading
        const url = new URL(window.location);
        url.searchParams.set('tab', tabName);
        window.history.pushState({}, '', url);
        
        // Update active tab button
        adminTabButtons.forEach(button => {
            button.classList.toggle('active', button.dataset.tab === tabName);
        });
        
        // Show/hide relevant rows
        adminRequestRows.forEach(row => {
            if (tabName === 'all' || row.dataset.type === tabName) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // After tab switch, re-apply current search filter
        filterRequests(); 
    }
    
    // Add click handlers to tab buttons
    adminTabButtons.forEach(button => {
        button.addEventListener('click', () => switchAdminTab(button.dataset.tab));
    });
    
    // Initialize with active tab from URL
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'all';
    switchAdminTab(activeTab);
})();

// Request filtering functionality
function filterRequests() {
    const input = document.getElementById('requestSearch');
    if (!input) return; // Exit if search input is not found
    
    const filter = input.value.toLowerCase();
    const table = document.querySelector('.dashboard-table');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) { // Start from 1 to skip the header row
        let found = false;
        const row = tr[i];
        
        // If the row is already hidden by a tab, skip search filtering unless it's the 'all' tab.
        // Or if it's the 'all' tab, always search.
        const activeTabFromURL = new URLSearchParams(window.location.search).get('tab') || 'all';
        if (activeTabFromURL !== 'all' && row.dataset.type !== activeTabFromURL) {
            row.style.display = 'none';
            continue;
        }

        const tdId = row.getElementsByTagName('td')[0]; // ID column
        const tdName = row.getElementsByTagName('td')[1]; // Name column
        const tdType = row.getElementsByTagName('td')[2]; // Request Type column

        if (tdId && tdId.textContent.toLowerCase().indexOf(filter) > -1) {
            found = true;
        } else if (tdName && tdName.textContent.toLowerCase().indexOf(filter) > -1) {
            found = true;
        } else if (tdType && tdType.textContent.toLowerCase().indexOf(filter) > -1) {
            found = true;
        }

        // Only apply display change if not already hidden by tab and matches filter
        if (found) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}

// Request status update functions
function updateRequestStatus(requestId, newStatus) {
    // Implement AJAX call to update request status
    fetch(`/update-request-status/${requestId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error updating request status');
        }
    });
}

function updateDentalAppointment(requestId) {
    // Implement AJAX call to update dental appointment
    fetch(`/update-dental-appointment/${requestId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error updating dental appointment');
        }
    });
}

function updateMentalHealthStatus(requestId, newStatus) {
    // Implement AJAX call to update mental health status
    fetch(`/update-mental-health-status/${requestId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error updating mental health status');
        }
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addPatientPrompt(event) {
    event.preventDefault(); // Prevent default link behavior
    Swal.fire({
        title: 'Register New User As:',
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: 'Student',
        denyButtonText: 'Faculty',
        cancelButtonText: 'Cancel',
        customClass: {
            confirmButton: 'swal2-confirm-button',
            denyButton: 'swal2-deny-button',
            cancelButton: 'swal2-cancel-button'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '{% url "main:register" %}'; // Student registration
        } else if (result.isDenied) {
            window.location.href = '{% url "main:register" %}?role=faculty'; // Faculty registration
        }
    });
}

function sendFacultyRegistrationLinkPrompt(event) {
    event.preventDefault(); // Prevent default link behavior

    Swal.fire({
        title: 'Send Faculty Registration Link',
        input: 'email',
        inputLabel: 'Faculty Email Address',
        inputPlaceholder: 'Enter faculty email',
        showCancelButton: true,
        confirmButtonText: 'Send Link',
        showLoaderOnConfirm: true,
        preConfirm: (email) => {
            if (!email) {
                Swal.showValidationMessage('Email address is required');
                return false; // Prevent closing the modal
            }
            // Basic email format validation
            const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
            if (!emailRegex.test(email)) {
                Swal.showValidationMessage('Please enter a valid email address');
                return false; // Prevent closing the modal
            }
            
            // Send AJAX request
            return fetch('{% url "main:send_faculty_registration_link" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.message || 'Network response was not ok.');
                    });
                }
                return response.json();
            })
            .catch(error => {
                Swal.showValidationMessage(`Request failed: ${error.message}`);
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: result.value.message,
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: result.value.message || 'An unknown error occurred.',
                });
            }
        }
    });
}
</script>
{% endblock %}